# makefile for sitsang project

ROOT_DIR = $(shell pwd)
SRC_DIR = $(ROOT_DIR)/src
ARCH_DIR = $(ROOT_DIR)/arch
INC_DIR = $(ROOT_DIR)/include
CONFIG_DIR = $(ROOT_DIR)/config
SCRIPTS_DIR = $(ROOT_DIR)/scripts

HPATH           = $(TOPDIR)/include

all:
	$(MAKE) -C $(ARCH_DIR)

.PHONY: config
config: $(CONFIG_DIR)/config.in
	cd $(CONFIG_DIR); /bin/bash $(SCRIPTS_DIR)/Configure $(CONFIG_DIR)/config.in
	@rm -f $(SRC_DIR)/arch.config
	@if egrep "^CONFIG_DEFAULTS_INTEL_I386" $(CONFIG_DIR)/.config > /dev/null; then \
		rm arch; ln -s arch-x86 arch; \
	fi
	@if egrep "^CONFIG_DEFAULTS_ARM_INTEL_XSCALE" $(CONFIG_DIR)/.config > /dev/null; then \
		rm arch; ln -s arch-arm arch; \
	fi
	@echo "#This dir.config file is automaticly generated by make config!" > $(SRC_DIR)/dir.config
	@echo "ROOT_DIR="$(ROOT_DIR) >> $(SRC_DIR)/dir.config
	@echo "CONFIG_DIR="$(CONFIG_DIR) >> $(SRC_DIR)/dir.config
	@echo "SRC_DIR="$(SRC_DIR) >> $(SRC_DIR)/dir.config
	@echo "INC_DIR="$(INC_DIR) >> $(SRC_DIR)/dir.config
	@echo "SCRIPTS_DIR="$(SCRIPTS_DIR) >> $(SRC_DIR)/dir.config
	@echo "HPATH="$(HPATH) >> $(SRC_DIR)/dir.config

.PHONY: dep
dep:
	$(MAKE) -C $(ARCH_DIR) dep 


.PHONY: test
test:
	$(MAKE) -C $(ARCH_DIR) test

# This one removes all executables from the tree and forces their relinking
clean:
	$(MAKE) -C $(ARCH_DIR) clean

cleanall:
	$(MAKE) -C arch-arm clean
	$(MAKE) -C arch-x86 clean


